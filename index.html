<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vtomo — Magical Ritual Reveal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --soft-white:#FAF9F6; --warm-beige:#F5EBDD; --peach:#FADCD9; --mist:#C6D8D8;
    --taupe:#A89F91; --ink:#1F2937; --gold:#D4AF37; --ring:#7A6F5A;
  }
  *{box-sizing:border-box;margin:0}
  body{
    font-family:Inter,system-ui,Segoe UI,Arial,sans-serif; color:var(--ink); min-height:100vh;
    background:
      radial-gradient(1200px 600px at 50% -20%, rgba(250,220,217,.55), transparent 60%),
      linear-gradient(180deg, var(--soft-white), var(--warm-beige));
    overflow-x:hidden;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:56px 20px}
  h1{
    font-family:"Playfair Display",serif;font-weight:700;font-size:clamp(32px,6vw,54px);
    text-align:center;line-height:1.15;
    background:linear-gradient(135deg,#111,#7A6F5A); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  p.lead{opacity:.85;text-align:center;margin:14px auto 28px;max-width:760px}

  .row{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin:18px 0}
  .note{opacity:.75;text-align:center;margin-top:8px}

  /* Elegant dropdown */
  .select{
    appearance:none; background:linear-gradient(180deg,#fff,#ffffffcc);
    border:1px solid rgba(168,159,145,.45); color:#3b3b3b; border-radius:14px;
    padding:14px 42px 14px 16px; min-width:260px;
    font-family:"Playfair Display",serif; font-size:16px; font-weight:600; text-align:center;
    cursor:pointer; box-shadow:0 6px 20px rgba(168,159,145,.12), inset 0 1px 0 #ffffff;
    transition:.25s; backdrop-filter: blur(6px);
    background-image:
      linear-gradient(180deg,#ffffff,#ffffffcc),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%237A6F5A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    background-repeat:no-repeat; background-position:left top, right 12px center; background-size:auto,18px;
  }
  .select:disabled{opacity:.6; cursor:not-allowed}
  .select:hover{ border-color:rgba(168,159,145,.8); box-shadow:0 10px 30px rgba(168,159,145,.18); }
  .select:focus{ outline:0; border-color:#b7a98f; box-shadow:0 0 0 3px #b7a98f33; }
  .select option{background:#fff;color:#222;}

  .btn{border:0;padding:12px 22px;border-radius:999px;font-weight:700;cursor:pointer;transition:.25s}
  .btn-primary{background:linear-gradient(135deg,#a78b6d,#d4af37);color:#fff;box-shadow:0 10px 24px rgba(212,175,55,.22)}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(212,175,55,.32)}
  .btn-ghost{
    background:#fff;border:1px solid rgba(168,159,145,.5); color:#6b6254;border-radius:999px;
    padding:10px 16px;font-weight:700;cursor:pointer;transition:.25s
  }
  .btn-ghost:hover{border-color:#b7a98f;box-shadow:0 8px 20px rgba(168,159,145,.18)}

  /* Stage (hidden until species chosen) */
  .stage{display:grid;place-items:center;margin:28px 0 10px}
  .stage.hidden{display:none;}
  .circle-wrap{position:relative; width:300px; height:300px}
  .circle{
    position:absolute; inset:10px; border-radius:50%; cursor:pointer;
    border:2px solid rgba(122,111,90,.55);
    box-shadow:inset 0 0 24px rgba(122,111,90,.15), 0 0 40px rgba(250,220,217,.25);
    animation:spin 24s linear infinite;
    background: radial-gradient(circle at 50% 50%, rgba(250,220,217,.35), transparent 60%);
    display:grid; place-items:center;
  }
  .rune{position:absolute; inset:0; border-radius:50%; border:1px dashed rgba(122,111,90,.35); animation:spin 18s linear infinite reverse;}
  .tap{position:absolute;inset:auto 0 12px 0;text-align:center;font-weight:700;opacity:.75;color:#6b6254;z-index:2}
  canvas.spark{position:absolute; inset:0; pointer-events:none}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  @keyframes quake {
    0%,100% { transform:translate(0,0) rotate(0deg) }
    10% { transform:translate(-2px,2px) rotate(-0.5deg) }
    20% { transform:translate(3px,-3px) rotate(0.6deg) }
    30% { transform:translate(-3px,1px) rotate(-0.6deg) }
    40% { transform:translate(2px,3px) rotate(0.5deg) }
    50% { transform:translate(-1px,-2px) rotate(-0.4deg) }
    60% { transform:translate(2px,2px) rotate(0.5deg) }
    70% { transform:translate(-2px,3px) rotate(-0.5deg) }
    80% { transform:translate(3px,-1px) rotate(0.6deg) }
    90% { transform:translate(-3px,2px) rotate(-0.6deg) }
  }
  .shaking { animation:quake .5s linear infinite; }

  /* Sections & cards */
  section{max-width:900px;margin:36px auto 0;padding:0 8px}
  .sec h2{font-family:"Playfair Display",serif;font-size:26px;margin-bottom:10px;color:#2b2b2b}
  .card-lite{background:#fff;border:1px solid rgba(168,159,145,.35);box-shadow:0 8px 22px rgba(168,159,145,.12);border-radius:16px;padding:16px}
  .ol{counter-reset:num}.ol li{list-style:none;margin:8px 0;padding-left:8px}.ol li:before{counter-increment:num;content:counter(num) ". ";font-weight:700;color:#6b6254}
  blockquote{background:linear-gradient(180deg,#fff,#fff9);border:1px solid rgba(168,159,145,.35);border-radius:16px;padding:14px 16px;font-style:italic;color:#4a4a4a}

  /* Result */
  .card{display:none;text-align:center;animation:fade .8s ease}
  .card.show{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  #resultCard{
    margin-top:14px; padding:18px 18px 22px; border-radius:18px; background:linear-gradient(180deg,#ffffff,#fff9);
    border:1px solid rgba(168,159,145,.35); box-shadow:0 12px 34px rgba(168,159,145,.16);
  }
  .img{width:240px;height:240px;border-radius:18px;margin:0 auto 14px;background:#f2f2f2;display:grid;place-items:center;
       box-shadow:0 12px 30px rgba(122,111,90,.12);overflow:hidden;border:1px solid rgba(168,159,145,.28)}
  .img img{width:100%;height:100%;object-fit:cover}
  .name{font-family:"Playfair Display",serif;font-size:28px;color:#1e1e1e;margin-bottom:6px;position:relative;display:inline-block;padding:0 4px}
  .name:after{content:"";position:absolute;left:0;right:0;bottom:-4px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);animation:glint 2.4s linear infinite}
  @keyframes glint{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  .role{color:#617b7b;margin-bottom:8px}
  .field{opacity:.95;max-width:620px;margin:6px auto}
  .label{font-weight:700;color:#6b6254}
  .toolbar{display:flex;gap:10px;justify-content:center;margin-top:12px}
  footer{opacity:.75;text-align:center;margin:48px 0 12px;font-size:14px;color:#6b6254}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Reveal Your Soul-Bonded Companion</h1>
    <p class="lead">Read the guide, choose your species, and perform the ritual. The first reveal is bound to your device for that species.</p>

    <!-- Guide first (prevents accidental taps) -->
    <section class="sec">
      <h2>How to Perform</h2>
      <div class="card-lite">
        <ol class="ol">
          <li>Choose your species below.</li>
          <li>The ritual circle will appear.</li>
          <li>Tap it once — it will tremble for ~5 seconds.</li>
          <li>Then your companion will be revealed. Save it if you wish.</li>
        </ol>
      </div>
    </section>

    <div class="row" style="margin-top:18px">
      <select id="species" class="select" disabled>
        <option value="" selected disabled>Select your species…</option>
      </select>
    </div>
    <p class="note" id="prepMsg">Please select a species to begin the ritual.</p>

    <!-- Circle appears only after a species is chosen -->
    <div class="stage hidden" id="stage">
      <div class="circle-wrap">
        <div class="rune"></div>
        <canvas class="spark" id="spark"></canvas>
        <div class="circle" id="circle"><div class="tap">Tap to Reveal</div></div>
      </div>
    </div>

    <div id="result" class="card">
      <div id="resultCard">
        <div class="img" id="imgBox">✨</div>
        <div class="name" id="name">—</div>
        <div class="role" id="role">—</div>
        <div class="field" id="personality">—</div>
        <div class="field" id="why">—</div>
        <div class="toolbar">
          <button class="btn-ghost" id="saveImg" disabled>Save as Image</button>
          <button class="btn-ghost" id="reset">Reset</button>
        </div>
        <p class="note" id="msg"></p>
      </div>
    </div>

    <!-- Bundles -->
    <section class="sec" id="bundlesSection">
      <h2>Bundles & Add-ons</h2>
      <div class="card-lite">
        <p>Explore curated sets and guardians to deepen your practice.</p>
        <p style="margin-top:8px">
          <a href="https://vtomo.etsy.com" target="_blank" class="btn btn-primary" style="display:inline-block;text-decoration:none;">Visit the Vtomo Shop</a>
        </p>
      </div>
    </section>

    <section class="sec">
      <h2>A Gentle Chant</h2>
      <blockquote>“I return to the quiet center, and let the truest part of me breathe.”</blockquote>
    </section>

    <footer>Personal use only • © Vtomo</footer>
  </div>

<!-- html2canvas for “Save as Image” -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/** 1) Your GViz JSON URL (sheet=companions) */
const GVIZ_URL = "https://docs.google.com/spreadsheets/d/1C4roXeCrWmFI_xPGoGLdanQlJueINxaoUvfEs4uX_OA/gviz/tq?tqx=out:json&sheet=companions";

/** 2) State */
const KEY_PREFIX = "vtomo_reveal_v1_";
let DB = {}; let speciesList = []; let busy = false;

/** 3) Fetch & parse sheet (robust headers; optional personality/why) */
async function fetchSheet(){
  const res = await fetch(GVIZ_URL, { cache: 'no-store' });
  const raw = await res.text();
  const jsonStr = raw.replace(/^[^{]+/, '').replace(/\)\s*;?\s*$/, '');
  const json = JSON.parse(jsonStr);

  const rows = (json.table.rows || []).map(r => (r.c || []).map(c => (c ? c.v : "")));
  const colLabels = (json.table.cols || []).map(c => (c.label || '').trim());
  const hasLabels = colLabels.some(l => l.length > 0);
  const header  = hasLabels ? colLabels : (rows[0] || []).map(x => (x || '').toString().trim());
  const dataRows= hasLabels ? rows : rows.slice(1);

  const H = {}; header.forEach((h,i)=> H[(h||'').toLowerCase().trim()] = i);

  const need = ['species','name','role','image_url'];
  for (const k of need){ if (!(k in H)) throw new Error('Missing column: '+k); }

  const idxPersonality = ('personality' in H) ? H['personality'] : H['whisper'];
  const idxWhy = H['why_he_chose_you'] ?? H['why'] ?? H['why_chose_you'];

  DB = {};
  dataRows.forEach(r=>{
    const species = ((r[H['species']]||'')+'').trim().toLowerCase();
    if (!species) return;
    const item = {
      species,
      name: ((r[H['name']]||'')+'').trim(),
      role: ((r[H['role']]||'')+'').trim(),
      image_url: ((r[H['image_url']]||'')+'').trim()
    };
    if (idxPersonality !== undefined) item.personality = ((r[idxPersonality]||'')+'').trim();
    if (idxWhy !== undefined)         item.why         = ((r[idxWhy]||'')+'').trim();
    (DB[species] ||= []).push(item);
  });

  speciesList = Object.keys(DB).sort();
}

/** 4) UI helpers */
function populateSpecies(){
  const sel = document.getElementById('species');
  sel.innerHTML = '<option value="" selected disabled>Select your species…</option>';
  speciesList.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s.charAt(0).toUpperCase()+s.slice(1);
    sel.appendChild(opt);
  });
  sel.disabled = false;
}

function pulse(){
  const circle = document.getElementById('circle');
  circle.style.boxShadow = "0 0 60px rgba(212,175,55,.45)";
  setTimeout(()=>{ circle.style.boxShadow=""; }, 500);
}

function resetSpecies(species){
  localStorage.removeItem(KEY_PREFIX + species);
  location.reload();
}

/** Spark burst */
function burstSpark(){
  const canvas = document.getElementById('spark');
  const circleWrap = canvas.parentElement;
  const d = circleWrap.clientWidth;
  canvas.width = d; canvas.height = d;
  const ctx = canvas.getContext('2d');

  const particles = [];
  const N = 90;
  for(let i=0;i<N;i++){
    const a = Math.random()*Math.PI*2;
    particles.push({
      x:d/2, y:d/2, vx:Math.cos(a)*(1.5+Math.random()*2.2), vy:Math.sin(a)*(1.5+Math.random()*2.2),
      life: 40+Math.random()*24, size:1+Math.random()*2, hue: 36+Math.random()*20
    });
  }

  let frame=0;
  (function step(){
    frame++;
    ctx.clearRect(0,0,d,d);
    particles.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.life--;
      ctx.beginPath();
      ctx.fillStyle=`hsla(${p.hue},60%,60%,${Math.max(p.life/50,0)})`;
      ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
      ctx.fill();
    });
    if (frame<70) requestAnimationFrame(step); else ctx.clearRect(0,0,d,d);
  })();
}

/** 5) Pick-once logic */
function pickOnceFor(species){
  const key = KEY_PREFIX + species;
  const saved = localStorage.getItem(key);
  if (saved) return JSON.parse(saved);
  const pool = DB[species] || [];
  if (!pool.length) throw new Error("No data for species: "+species);
  const idx = Math.floor(Math.random()*pool.length);
  const chosen = {...pool[idx], _idx: idx, _ts: Date.now()};
  localStorage.setItem(key, JSON.stringify(chosen));
  return chosen;
}

/** 6) Render (without auto-scroll until we call it) */
function render(c){
  const imgBox = document.getElementById('imgBox');
  imgBox.innerHTML = c.image_url ? `<img src="${c.image_url}" alt="${c.name}" crossOrigin="anonymous">` : "✨";
  document.getElementById('name').textContent = c.name || "—";
  document.getElementById('role').textContent = c.role || "—";
  document.getElementById('personality').innerHTML = c.personality ? `<span class="label">Personality:</span> ${c.personality}` : "—";
  document.getElementById('why').innerHTML         = c.why ? `<span class="label">Why He Chose You:</span> ${c.why}` : "—";
  document.getElementById('result').classList.add('show');
  document.getElementById('saveImg').disabled = false;
  document.getElementById('msg').textContent = "";
}

/** 7) Save as image */
async function saveAsImage(){
  const card = document.getElementById('resultCard');
  const canvas = await html2canvas(card, {backgroundColor:'#FFFFFF', scale:2});
  const url = canvas.toDataURL("image/png");
  const a = document.createElement('a');
  a.href = url;
  const sp = document.getElementById('species').value || 'companion';
  a.download = `vtomo_${sp}_reveal.png`;
  a.click();
}

/** 8) main */
(async function init(){
  try{
    await fetchSheet();
    if(!speciesList.length){ document.getElementById('prepMsg').textContent = "No data found."; return; }
    populateSpecies();
  }catch(e){
    document.getElementById('prepMsg').textContent = "Loading error. Please try again later.";
    console.error(e);
  }

  // Show circle only after choosing species
  document.getElementById('species').addEventListener('change', ()=>{
    const sp = document.getElementById('species').value;
    if (!sp) return;
    document.getElementById('stage').classList.remove('hidden');
    document.getElementById('result').classList.remove('show');
    document.getElementById('saveImg').disabled = true;
    document.getElementById('prepMsg').textContent = `Ready for the ${sp} ritual. Tap the circle once.`;
  });

  // Tap circle -> 5s shake + spark -> reveal
  document.getElementById('circle').addEventListener('click', async ()=>{
    if (busy) return;
    const sp = document.getElementById('species').value;
    if(!sp){ alert("Please select a species first."); return; }

    busy = true;
    const circle = document.getElementById('circle');
    // start effects
    circle.classList.add('shaking'); burstSpark(); pulse();

    // wait 5s
    await new Promise(r => setTimeout(r, 5000));
    circle.classList.remove('shaking');

    // determine result (saved or new), but only render now (after delay)
    const saved = localStorage.getItem(KEY_PREFIX + sp);
    const c = saved ? JSON.parse(saved) : pickOnceFor(sp);
    render(c);
    // now scroll into view smoothly
    document.getElementById('result').scrollIntoView({behavior:'smooth',block:'center'});

    busy = false;
  });

  document.getElementById('reset').addEventListener('click', ()=>{
    const sp = document.getElementById('species').value;
    if (!sp) return;
    if (confirm(`Reset the ${sp} reveal on this device?`)) resetSpecies(sp);
  });

  document.getElementById('saveImg').addEventListener('click', saveAsImage);

  // Resize canvas on window resize
  window.addEventListener('resize', ()=>{
    const canvas = document.getElementById('spark');
    if (!canvas) return;
    const d = canvas.parentElement.clientWidth;
    canvas.width = d; canvas.height = d;
  });
})();
</script>
</body>
</html>
