<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vtomo — Magical Ritual Reveal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* =============== THEME TOKENS =============== */
  :root{
    --transition:.35s ease;
    --shadow-strong:0 28px 70px rgba(0,0,0,.5);
    --shadow-soft:0 14px 44px rgba(0,0,0,.35);
  }
  html[data-theme="dark"]{
    --bg-deep:#0C1020; --bg-ink:#0B1220; --bg-soft:#11182A;
    --text:#F4F3F8; --muted:#C9C7D2;
    --gold:#E1C77A; --gold-deep:#B8994F;
    --violet:#8D7CCF; --opal:#9FB9D4;
    --ring:#6F6456;
    --card:#131A2B; --card-edge:#2A3348;
    --glass:rgba(255,255,255,.06);
    --btn-text:#222;
    --select-bg1:#ffffff; --select-bg2:#ECEBF3; --select-text:#111; --select-shadow:rgba(225,199,122,.16);
    --accent-edge:rgba(225,199,122,.28);
    --stage-vignette:rgba(0,0,0,.25);
    --spark-bg:#0B1220;
  }
  html[data-theme="light"]{
    --bg-deep:#FAF9F6; --bg-ink:#F4EFE9; --bg-soft:#EEE7E0;
    --text:#26252A; --muted:#56535F;
    --gold:#C6A45E; --gold-deep:#A38747;
    --violet:#7B6AC0; --opal:#7FA1B8;
    --ring:#84765F;
    --card:#FFFFFF; --card-edge:#E9E2DA;
    --glass:rgba(255,255,255,.86);
    --btn-text:#1A1A1A;
    --select-bg1:#FFFFFF; --select-bg2:#F6F2EC; --select-text:#222; --select-shadow:rgba(167,137,75,.16);
    --accent-edge:rgba(167,137,75,.30);
    --stage-vignette:rgba(150,134,120,.14);
    --spark-bg:#F7F3EE;
    --shadow-strong:0 24px 60px rgba(0,0,0,.14);
    --shadow-soft:0 12px 38px rgba(0,0,0,.08);
  }

  *{box-sizing:border-box;margin:0}
  body{
    font-family:Inter,system-ui,Segoe UI,Arial,sans-serif; color:var(--text); min-height:100vh;
    background:
      radial-gradient(1200px 600px at 50% -20%, var(--bg-ink), var(--bg-ink)),
      radial-gradient(1200px 600px at 50% 120%, rgba(28,21,55,.30), transparent 60%),
      linear-gradient(180deg, var(--bg-deep), var(--bg-ink));
    overflow-x:hidden; transition: background var(--transition), color var(--transition);
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:radial-gradient(900px 360px at 50% -80px, transparent, var(--stage-vignette) 75%),
               radial-gradient(1100px 480px at 50% 110%, transparent, var(--stage-vignette) 70%);
    z-index:0;
  }
  .wrap{max-width:1120px;margin:0 auto;padding:64px 20px; position:relative; z-index:1}
  header.topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;}
  .brand{
    font-family:"Playfair Display",serif; font-weight:700; letter-spacing:.3px;
    font-size:clamp(22px,3vw,28px);
    background:linear-gradient(135deg,#fff, var(--gold) 40%, var(--violet) 80%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .theme-toggle{
    display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px;
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    border:1px solid var(--accent-edge); cursor:pointer; backdrop-filter: blur(6px);
    box-shadow:var(--shadow-soft); color:var(--text); font-weight:700; transition:transform .2s;
  }
  html[data-theme="light"] .theme-toggle{ background:linear-gradient(180deg, #fff, #FAF7F2) }
  .theme-toggle:hover{ transform:translateY(-1px) }
  .theme-toggle svg{ width:18px; height:18px }

  h1{
    font-family:"Playfair Display",serif;font-weight:700;font-size:clamp(34px,6vw,56px);
    text-align:center;line-height:1.15; letter-spacing:.3px;
    background:linear-gradient(135deg,#fff, var(--gold) 40%, var(--violet) 80%);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  p.lead{opacity:.9;text-align:center;margin:16px auto 32px;max-width:760px;color:var(--muted)}

  section{max-width:920px;margin:38px auto 0;padding:0 8px}
  .sec h2{font-family:"Playfair Display",serif;font-size:26px;margin-bottom:12px;letter-spacing:.2px}
  .card-lite{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--accent-edge); border-radius:16px; padding:18px; box-shadow:var(--shadow-soft);
    transition: background var(--transition), border-color var(--transition), box-shadow var(--transition);
  }
  html[data-theme="light"] .card-lite{ background:#fff }

  .ol{counter-reset:num}.ol li{list-style:none;margin:10px 0;padding-left:8px;color:var(--muted)}
  .ol li:before{counter-increment=num;content:counter(num) ". ";font-weight:800;color:var(--gold)}

  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:22px 0}
  .note{opacity:.8;text-align:center;margin-top:10px;color:var(--muted)}
  .btn{border:0;padding:12px 22px;border-radius:999px;font-weight:700;cursor:pointer;transition:.25s}
  .btn-primary{
    background:linear-gradient(135deg, var(--gold-deep), var(--gold));
    color:var(--btn-text); box-shadow:0 10px 26px rgba(225,199,122,.28);
    border:1px solid rgba(199,167,84,.55); text-decoration:none;
  }
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(225,199,122,.36)}
  .btn-ghost{
    background:var(--glass); border:1px solid rgba(255,255,255,.18); color:inherit;border-radius:999px;
    padding:10px 16px;font-weight:700;cursor:pointer;transition:.25s; backdrop-filter: blur(6px);
  }
  .btn-ghost:hover{border-color:#c9b37a;box-shadow:0 10px 24px rgba(199,167,84,.18)}

  /* ======== Combobox ======== */
  .combo{position:relative; min-width:320px;}
  .combo-input{
    width:100%; padding:14px 44px 14px 16px; border-radius:14px; border:1px solid var(--accent-edge);
    background: linear-gradient(180deg,var(--select-bg1),var(--select-bg2));
    color:var(--select-text); font-family:"Playfair Display",serif; font-weight:700; font-size:16px;
    box-shadow:0 14px 30px var(--select-shadow), inset 0 1px 0 #fff; outline:none;
  }
  .combo .arrow{
    position:absolute; right:12px; top:50%; transform:translateY(-50%);
    width:18px; height:18px; pointer-events:none;
  }
  .combo-list{
    position:absolute; left:0; right:0; top:calc(100% + 8px); z-index:20;
    background:#fff; color:#111; border:1px solid #e4e0d8; border-radius:12px;
    box-shadow:0 18px 44px rgba(0,0,0,.18); max-height:260px; overflow:auto; display:none;
  }
  html[data-theme="dark"] .combo-list{ background:#131a2b; color:#f4f3f8; border-color:#2a3348 }
  .combo.open .combo-list{ display:block; }
  .combo-item{ padding:10px 12px; cursor:pointer; }
  .combo-item:hover, .combo-item.active{ background:rgba(199,167,84,.16) }

  /* ======== Ritual circle & effects ======== */
  .stage{display:grid;place-items:center;margin:30px 0 14px}
  .stage.hidden{display:none;}
  .circle-wrap{position:relative; width:340px; height:340px; filter:drop-shadow(0 20px 40px rgba(0,0,0,.4))}
  .ring{
    position:absolute; inset:0; border-radius:50%; pointer-events:none;
    background:conic-gradient(from 0deg, rgba(225,199,122,.0), rgba(225,199,122,.5), rgba(225,199,122,.0) 40%);
    mask: radial-gradient(circle at 50% 50%, transparent 62%, #000 62.5%);
    animation: ringSpin 14s linear infinite; opacity:.9;
  }
  @keyframes ringSpin{to{transform:rotate(360deg)}}
  .rune-dots{
    position:absolute; inset:20px; border-radius:50%; border:2px dotted rgba(225,199,122,.35); pointer-events:none;
    animation: spinRev 22s linear infinite;
  }
  @keyframes spinRev{to{transform:rotate(-360deg)}}
  .sigils{ position:absolute; inset:0; pointer-events:none; color:#C9B7FD; text-shadow:0 0 12px rgba(141,124,207,.65); opacity:.9 }
  .sigil{ position:absolute; font-size:18px; font-weight:700; transform:translate(-50%,-50%) }
  .s1{left:50%; top:4%} .s2{left:84%; top:18%} .s3{left:96%; top:50%}
  .s4{left:84%; top:82%} .s5{left:50%; top:96%} .s6{left:16%; top:82%}
  .s7{left:4%;  top:50%} .s8{left:16%; top:18%}

  .circle{
    position:absolute; inset:16px; border-radius:50%; cursor:pointer;
    border:2px solid rgba(225,199,122,.42);
    background:
      radial-gradient(220px 120px at 50% 25%, rgba(225,199,122,.18), transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(98,117,168,.22), rgba(98,117,168,.08) 60%, transparent 70%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    display:grid; place-items:center;
    box-shadow:inset 0 0 22px rgba(225,199,122,.18), 0 0 46px rgba(141,124,207,.38);
    animation:spin 26s linear infinite;
  }
  .tap{position:absolute;inset:auto 0 14px 0;text-align:center;font-weight:800;letter-spacing:.4px;color:#E1DDF2;z-index:2}
  canvas.spark{position:absolute; inset:0; pointer-events:none}
  .flash{ position:absolute; inset:0; border-radius:50%; pointer-events:none; opacity:0;
    background:radial-gradient(circle,#fff,rgba(255,255,255,.0) 60%); filter:blur(2px); transition:opacity .25s ease; }
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  @keyframes quake {
    0%,100% { transform:translate(0,0) rotate(0deg) }
    10% { transform:translate(-2px,2px) rotate(-0.5deg) }
    20% { transform:translate(3px,-3px) rotate(0.6deg) }
    30% { transform:translate(-3px,1px) rotate(-0.6deg) }
    40% { transform:translate(2px,3px) rotate(0.5deg) }
    50% { transform:translate(-1px,-2px) rotate(-0.4deg) }
    60% { transform:translate(2px,2px) rotate(0.5deg) }
    70% { transform:translate(-2px,3px) rotate(-0.5deg) }
    80% { transform:translate(3px,-1px) rotate(0.6deg) }
    90% { transform:translate(-3px,2px) rotate(-0.6deg) }
  }
  .shaking { animation:quake .5s linear infinite; }
  .charging { box-shadow:inset 0 0 28px rgba(225,199,122,.34), 0 0 70px rgba(141,124,207,.55); }

  /* ======== Result card ======== */
  .card{display:none;text-align:center}
  .card.show{display:block}
  #resultCard{
    margin-top:16px; padding:26px 24px 26px; border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--accent-edge); box-shadow:var(--shadow-strong);
    transform:scale(.96); opacity:0; animation:revealPop .7s ease .05s forwards;
    position:relative; overflow:visible; transition: background var(--transition), border-color var(--transition);
  }
  html[data-theme="light"] #resultCard{ background:#fff }
  #resultCard::before{
    content:""; position:absolute; inset:-10px; border-radius:24px;
    background:
      linear-gradient(135deg, rgba(255,255,255,.0), rgba(255,255,255,.35)),
      conic-gradient(from 0deg, #b8944a 0%, #e5d09a 25%, #b8944a 50%, #e5d09a 75%, #b8944a 100%);
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
    padding:3px; opacity:.7; pointer-events:none; box-shadow:0 0 30px rgba(199,167,84,.12);
  }
  .img{
    width:252px;height:252px;border-radius:18px;margin:0 auto 18px;background:#0F1525;display:grid;place-items:center;
    box-shadow:0 12px 32px rgba(0,0,0,.55);overflow:hidden;border:1px solid var(--accent-edge); position:relative;
  }
  html[data-theme="light"] .img{ background:#EFE9E1 }
  .img img{width:100%;height:100%;object-fit:cover}
  .aura{position:absolute; left:50%; top:0; width:0; height:0; pointer-events:none}
  .orb{position:absolute; width:8px;height:8px;border-radius:50%;
       background:radial-gradient(circle,#fff, rgba(255,255,255,.0) 70%); box-shadow:0 0 16px rgba(225,199,122,.6); opacity:.95}
  .orbit{position:absolute; left:-132px; top:-132px; width:264px; height:264px; border-radius:50%; pointer-events:none; animation:orbit 12s linear infinite;}
  .orbit.slow{animation-duration:16s; opacity:.8}
  .orbit.fast{animation-duration:9s; opacity:.9}
  @keyframes orbit{to{transform:rotate(360deg)}}
  .name{font-family:"Playfair Display",serif;font-size:28px;margin-bottom:6px;position:relative;display:inline-block;padding:0 4px; letter-spacing:.2px}
  .name:after{content:"";position:absolute;left:0;right:0;bottom:-4px;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);animation:glint 2.6s linear infinite}
  @keyframes glint{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  .role{color:#BFD3F7;margin-bottom:10px}
  html[data-theme="light"] .role{ color:#53698A }
  .field{opacity:.95;max-width:660px;margin:8px auto}
  .label{font-weight:800;color:#F0E4BC; letter-spacing:.2px}
  html[data-theme="light"] .label{ color:#A0812E }
  .toolbar{display:flex;gap:10px;justify-content:center;margin-top:16px}
  footer{opacity:.8;text-align:center;margin:56px 0 14px;font-size:14px}
  .visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px);padding:0!important;border:0!important;height:1px!important;width:1px!important;overflow:hidden}
  .faq dt{font-weight:800;margin-top:12px}
  .faq dd{margin:6px 0 14px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">Vtomo</div>
      <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <svg id="iconSun" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="display:none"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M2 12h2m16 0h2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
        <svg id="iconMoon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        <span id="themeText">Dark</span>
      </button>
    </header>

    <h1>Reveal Your Soul-Bonded Companion</h1>
    <p class="lead">Read the guide, choose your species, and perform the ritual. The first reveal is bound to your device for that species.</p>

    <section class="sec">
      <h2>How to Perform</h2>
      <div class="card-lite">
        <ol class="ol">
          <li>Use the Species box to search & select.</li>
          <li>The ritual circle will appear.</li>
          <li>Tap it once.</li>
          <li>Your companion is revealed.</li>
        </ol>
      </div>
    </section>

    <!-- Combobox -->
    <div class="row" style="margin-top:18px">
      <div class="combo" id="speciesCombo" aria-haspopup="listbox" aria-owns="speciesListbox">
        <input id="comboInput" class="combo-input" type="text" placeholder="Species… (type to search)" aria-autocomplete="list" aria-expanded="false" autocomplete="off" disabled />
        <svg class="arrow" viewBox="0 0 24 24" stroke="%23B8994F" fill="none"><polyline points="6 9 12 15 18 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div class="combo-list" id="comboList" role="listbox" aria-label="Species" ></div>
      </div>
    </div>
    <p class="note" id="prepMsg">Please choose a species to begin the ritual.</p>

    <!-- Ritual stage -->
    <div class="stage hidden" id="stage">
      <div class="circle-wrap">
        <div class="ring"></div>
        <div class="rune-dots"></div>
        <div class="sigils" aria-hidden="true">
          <span class="sigil s1">✶</span><span class="sigil s2">❖</span><span class="sigil s3">☽</span><span class="sigil s4">✦</span>
          <span class="sigil s5">✶</span><span class="sigil s6">❖</span><span class="sigil s7">☽</span><span class="sigil s8">✦</span>
        </div>
        <canvas class="spark" id="spark"></canvas>
        <div class="flash" id="flash"></div>
        <div class="circle" id="circle"><div class="tap">Tap to Reveal</div></div>
      </div>
    </div>

    <div id="result" class="card">
      <div id="resultCard">
        <div class="img" id="imgBox">
          <div class="aura" id="aura"></div>
        </div>
        <div class="name" id="name">—</div>
        <div class="role" id="role">—</div>
        <div class="field" id="personality">—</div>
        <div class="field" id="why">—</div>
        <div class="toolbar">
          <!-- Save button removed -->
          <button class="btn-ghost" id="reset">Reset</button>
        </div>
        <p class="note" id="msg"></p>
      </div>
    </div>

    <!-- Gentle Chant -->
    <section class="sec">
      <h2>A Gentle Chant</h2>
      <div class="card-lite" style="padding:14px 16px">
        <em style="color:inherit;opacity:.9">“I return to the quiet center, and let the truest part of me breathe.”</em>
      </div>
    </section>

    <!-- FAQ -->
    <section class="sec">
      <h2>FAQ</h2>
      <div class="card-lite">
        <dl class="faq">
          <dt>Is the first reveal permanent?</dt>
          <dd>The first reveal is saved on your current device for the selected species. You can reset it from the toolbar if you wish.</dd>
          <dt>Can I save the reveal as an image?</dt>
          <dd>Image saving is currently disabled to keep the ritual simple and stable.</dd>
          <dt>Does theme affect the reveal?</dt>
          <dd>Yes. The on-page reveal follows your current theme (Dark or Light).</dd>
        </dl>
      </div>
    </section>

    <!-- Bundles -->
    <section class="sec" id="bundlesSection" style="margin-bottom:36px">
      <h2>Bundles & Add-ons</h2>
      <div class="card-lite" style="display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:16px">
        <p style="color:var(--muted); margin:0; flex:1 1 420px">Explore curated sets and guardians to deepen your practice.</p>
        <p style="margin:0">
          <a href="https://vtomo.etsy.com" target="_blank" class="btn btn-primary" style="padding:12px 24px">Visit the Vtomo Shop</a>
        </p>
      </div>
    </section>

    <footer>Personal use only • © Vtomo</footer>
  </div>

<script>
/** Sheet JSON URL */
const GVIZ_URL = "https://docs.google.com/spreadsheets/d/1C4roXeCrWmFI_xPGoGLdanQlJueINxaoUvfEs4uX_OA/gviz/tq?tqx=out:json&sheet=companions";

/** State */
const KEY_PREFIX = "vtomo_reveal_v1_";
const THEME_KEY = "vtomo_theme";
let DB = {}; let speciesList = []; let busy = false;

/* ===== THEME (Default Dark on first visit) ===== */
(function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const first = saved || 'dark';
  applyTheme(first);
})();
function applyTheme(theme){
  const html = document.documentElement;
  html.setAttribute('data-theme', theme);
  const isDark = theme === 'dark';
  document.getElementById('iconSun').style.display = isDark ? 'none':'block';
  document.getElementById('iconMoon').style.display = isDark ? 'block':'none';
  document.getElementById('themeText').textContent = isDark ? 'Dark' : 'Light';
  localStorage.setItem(THEME_KEY, theme);
}
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  applyTheme(cur === 'dark' ? 'light' : 'dark');
});

/* ===== Fetch & parse sheet ===== */
async function fetchSheet(){
  const res = await fetch(GVIZ_URL, { cache: 'no-store' });
  const raw = await res.text();
  const jsonStr = raw.replace(/^[^{]+/, '').replace(/\)\s*;?\s*$/, '');
  const json = JSON.parse(jsonStr);

  const rows = (json.table.rows || []).map(r => (r.c || []).map(c => (c ? c.v : "")));
  const colLabels = (json.table.cols || []).map(c => (c.label || '').trim());
  const hasLabels = colLabels.some(l => l.length > 0);
  const header  = hasLabels ? colLabels : (rows[0] || []).map(x => (x || '').toString().trim());
  const dataRows= hasLabels ? rows : rows.slice(1);

  const H = {}; header.forEach((h,i)=> H[(h||'').toLowerCase().trim()] = i);
  const need = ['species','name','role','image_url'];
  for (const k of need){ if (!(k in H)) throw new Error('No column: '+k); }

  const idxPersonality = ('personality' in H) ? H['personality'] : H['whisper'];
  const idxWhy = H['why_he_chose_you'] ?? H['why'] ?? H['why_chose_you'];

  DB = {};
  dataRows.forEach(r=>{
    const species = ((r[H['species']]||'')+'').trim().toLowerCase();
    if (!species) return;
    const item = {
      species,
      name: ((r[H['name']]||'')+'').trim(),
      role: ((r[H['role']]||'')+'').trim(),
      image_url: ((r[H['image_url']]||'')+'').trim()
    };
    if (idxPersonality !== undefined) item.personality = ((r[idxPersonality]||'')+'').trim();
    if (idxWhy !== undefined)         item.why         = ((r[idxWhy]||'')+'').trim();
    (DB[species] ||= []).push(item);
  });

  speciesList = Object.keys(DB).sort();
}

/* ===== Combobox ===== */
const combo = document.getElementById('speciesCombo');
const comboInput = document.getElementById('comboInput');
const comboList  = document.getElementById('comboList');
let activeIndex = -1;
let viewList = []; // filtered view

function openList(){
  combo.classList.add('open');
  comboInput.setAttribute('aria-expanded', 'true');
}
function closeList(){
  combo.classList.remove('open');
  comboInput.setAttribute('aria-expanded', 'false');
  activeIndex = -1;
}
function renderList(items){
  comboList.innerHTML = '';
  items.forEach((s, i)=>{
    const div = document.createElement('div');
    div.className = 'combo-item' + (i===activeIndex ? ' active': '');
    div.role = 'option';
    div.textContent = s.charAt(0).toUpperCase()+s.slice(1);
    div.dataset.value = s;
    div.addEventListener('mousedown', (e)=>{ e.preventDefault(); chooseSpecies(s); });
    comboList.appendChild(div);
  });
}
function filterList(q){
  const lc = q.trim().toLowerCase();
  viewList = !lc ? speciesList : speciesList.filter(s => s.includes(lc));
  if (!viewList.length){ comboList.innerHTML = '<div class="combo-item" aria-disabled="true" style="opacity:.6">No matches</div>'; return; }
  renderList(viewList);
}
function chooseSpecies(value){
  comboInput.value = value.charAt(0).toUpperCase()+value.slice(1);
  closeList();
  onSpeciesChosen(value);
}
comboInput.addEventListener('focus', ()=>{
  if (comboInput.disabled) return;
  filterList(comboInput.value);
  openList();
});
comboInput.addEventListener('input', ()=>{
  filterList(comboInput.value);
  openList();
});
comboInput.addEventListener('keydown', (e)=>{
  const count = viewList.length;
  if (e.key === 'ArrowDown'){ e.preventDefault(); if(!combo.classList.contains('open')) openList(); activeIndex = (activeIndex+1)%Math.max(count,1); renderList(viewList); }
  else if (e.key === 'ArrowUp'){ e.preventDefault(); if(!combo.classList.contains('open')) openList(); activeIndex = (activeIndex-1+Math.max(count,1))%Math.max(count,1); renderList(viewList); }
  else if (e.key === 'Enter'){ e.preventDefault(); if (combo.classList.contains('open') && count>0){ const v = activeIndex>=0 ? viewList[activeIndex] : viewList[0]; chooseSpecies(v); } }
  else if (e.key === 'Escape'){ closeList(); }
});
document.addEventListener('click', (e)=>{ if (!combo.contains(e.target)) closeList(); });

/* ===== Ritual VFX & aura ===== */
function pulse(){
  const circle = document.getElementById('circle');
  circle.style.boxShadow = "0 0 90px rgba(225,199,122,.55)";
  setTimeout(()=>{ circle.style.boxShadow=""; }, 520);
}
function burstSpark(){
  const canvas = document.getElementById('spark');
  const wrap = canvas.parentElement;
  const d = wrap.clientWidth;
  canvas.width = d; canvas.height = d;
  const ctx = canvas.getContext('2d');
  const particles = []; const N = 90;
  for(let i=0;i<N;i++){
    const a = Math.random()*Math.PI*2;
    particles.push({x:d/2,y:d/2,vx:Math.cos(a)*(1.5+Math.random()*2.2),vy:Math.sin(a)*(1.5+Math.random()*2.2),life:40+Math.random()*24,size:1+Math.random()*2,hue:36+Math.random()*20});
  }
  let frame=0;
  (function step(){ frame++; ctx.clearRect(0,0,d,d);
    particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.life--; ctx.beginPath(); ctx.fillStyle=`hsla(${p.hue},60%,60%,${Math.max(p.life/50,0)})`; ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); });
    if (frame<70) requestAnimationFrame(step); else ctx.clearRect(0,0,d,d);
  })();
}
function superBurst(){
  const canvas = document.getElementById('spark');
  const flash = document.getElementById('flash');
  const d = canvas.parentElement.clientWidth;
  canvas.width = d; canvas.height = d;
  const ctx = canvas.getContext('2d');
  const particles = []; const N = 200;
  for(let i=0;i<N;i++){
    const a = Math.random()*Math.PI*2; const sp = 2.2 + Math.random()*3.6;
    particles.push({x:d/2,y:d/2,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:46+Math.random()*30,size:1.2+Math.random()*2.8,hue:42+Math.random()*24});
  }
  flash.style.opacity = 0.95; setTimeout(()=> flash.style.opacity = 0, 260);
  let frame=0;
  (function step(){ frame++; ctx.clearRect(0,0,d,d);
    particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.life--; ctx.beginPath(); ctx.fillStyle=`hsla(${p.hue},70%,62%,${Math.max(p.life/55,0)})`; ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); });
    if (frame<95) requestAnimationFrame(step); else ctx.clearRect(0,0,d,d);
  })();
}
function buildAura(){
  const aura = document.getElementById('aura'); aura.innerHTML = '';
  const mkOrbit = (cls, r, count) => {
    const orbit = document.createElement('div'); orbit.className = 'orbit '+cls;
    orbit.style.left = (-r)+'px'; orbit.style.top = (-r)+'px';
    orbit.style.width = (r*2)+'px'; orbit.style.height= (r*2)+'px';
    for(let i=0;i<count;i++){
      const o = document.createElement('span'); o.className='orb';
      const t = (i/count)*360;
      o.style.left = (r + (r-6)*Math.cos(t*Math.PI/180))+'px';
      o.style.top  = (r + (r-6)*Math.sin(t*Math.PI/180))+'px';
      orbit.appendChild(o);
    }
    aura.appendChild(orbit);
  };
  mkOrbit('slow', 134, 6); mkOrbit('fast', 108, 4);
}

/* Pick-once */
function pickOnceFor(species){
  const key = KEY_PREFIX + species;
  const saved = localStorage.getItem(key);
  if (saved) return JSON.parse(saved);
  const pool = DB[species] || [];
  if (!pool.length) throw new Error("No data for species: "+species);
  const idx = Math.floor(Math.random()*pool.length);
  const chosen = {...pool[idx], _idx: idx, _ts: Date.now()};
  localStorage.setItem(key, JSON.stringify(chosen));
  return chosen;
}

/* Render */
function render(c){
  const imgBox = document.getElementById('imgBox');
  imgBox.innerHTML = `<div class="aura" id="aura"></div>` + (c.image_url ? `<img src="${c.image_url}" alt="${c.name}" crossOrigin="anonymous">` : "✨");
  buildAura();
  document.getElementById('name').textContent = c.name || "—";
  document.getElementById('role').textContent = c.role || "—";
  document.getElementById('personality').innerHTML = c.personality ? `<span class="label">Personality:</span> ${c.personality}` : "—";
  document.getElementById('why').innerHTML         = c.why ? `<span class="label">Why He Chose You:</span> ${c.why}` : "—";
  document.getElementById('result').classList.add('show');
  const card = document.getElementById('resultCard'); card.style.animation='none'; card.getBoundingClientRect(); card.style.animation='';
  document.getElementById('msg').textContent = "";
}

/* Species chosen -> show stage */
function onSpeciesChosen(sp){
  window.currentSpecies = sp;
  document.getElementById('stage').classList.remove('hidden');
  document.getElementById('result').classList.remove('show');
  document.getElementById('prepMsg').textContent = `Ready for the ${sp} ritual. Tap the circle once.`;
}

/* ===== Init ===== */
(async function init(){
  try{
    await fetchSheet();
    if (!speciesList.length){ document.getElementById('prepMsg').textContent = "No data found."; return; }
    comboInput.disabled = false;
    filterList('');
  }catch(e){
    document.getElementById('prepMsg').textContent = "Loading error. Please try again later.";
    console.error(e);
  }

  document.getElementById('circle').addEventListener('click', async ()=>{
    if (busy) return;
    const sp = window.currentSpecies;
    if(!sp){ alert("Please choose a species first."); return; }
    busy = true;
    const circle = document.getElementById('circle');
    burstSpark(); pulse();
    circle.classList.add('shaking','charging');
    await new Promise(r => setTimeout(r, 5000));
    circle.classList.remove('shaking','charging');
    superBurst();
    const saved = localStorage.getItem(KEY_PREFIX + sp);
    const c = saved ? JSON.parse(saved) : pickOnceFor(sp);
    render(c);
    document.getElementById('result').scrollIntoView({behavior:'smooth',block:'center'});
    busy = false;
  });

  document.getElementById('reset').addEventListener('click', ()=>{
    const sp = window.currentSpecies; if (!sp) return;
    if (confirm(`Reset the ${sp} reveal on this device?`)){
      localStorage.removeItem(KEY_PREFIX + sp); location.reload();
    }
  });

  window.addEventListener('resize', ()=>{
    const canvas = document.getElementById('spark');
    if (!canvas) return; const d = canvas.parentElement.clientWidth; canvas.width = d; canvas.height = d;
  });
})();
</script>
</body>
</html>
