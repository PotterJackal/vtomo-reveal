<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vtomo — Magical Ritual Reveal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0F172A; --bg2:#312E81; --text:#F9FAFB;
    --accent1:#F472B6; --accent2:#22D3EE; --gold:#FACC15;
  }
  *{box-sizing:border-box;margin:0}
  body{
    font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
    color:var(--text); min-height:100vh;
    background: radial-gradient(1200px 600px at 50% -10%, rgba(244,114,182,.18), transparent 60%),
                linear-gradient(135deg,var(--bg1),var(--bg2));
    overflow-x:hidden;
  }
  .wrap{max-width:1000px;margin:0 auto;padding:56px 20px}
  h1{font-family:"Playfair Display",serif;font-weight:700;font-size:clamp(32px,6vw,56px);text-align:center;line-height:1.15;
     background:linear-gradient(135deg,#fff,var(--accent1));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  p.lead{opacity:.9;text-align:center;margin:14px auto 28px;max-width:700px}
  .row{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin:18px 0}
  .select{appearance:none;background:#ffffff14;border:1px solid #ffffff2a;color:#fff;border-radius:12px;padding:12px 14px;min-width:220px}
  .btn{border:0;padding:12px 22px;border-radius:999px;font-weight:700;cursor:pointer;transition:.25s}
  .btn-primary{background:linear-gradient(135deg,#F472B6,#FB923C);color:#fff;box-shadow:0 10px 30px rgba(244,114,182,.35)}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 16px 40px rgba(244,114,182,.5)}
  .stage{display:grid;place-items:center;margin:28px 0 10px}
  .circle{
    width:280px;height:280px;border-radius:50%;
    border:3px solid rgba(244,114,182,.6);position:relative;cursor:pointer;
    animation:spin 20s linear infinite;
    box-shadow:0 0 60px rgba(244,114,182,.15), inset 0 0 30px rgba(34,211,238,.12);
  }
  .circle:before,.circle:after{content:"";position:absolute;inset:18px;border-radius:50%}
  .circle:before{border:2px solid rgba(34,211,238,.35);animation:spin 14s linear infinite reverse}
  .circle:after{inset:46%;background:radial-gradient(circle, rgba(244,114,182,.35), rgba(34,211,238,.18))}
  .tap{position:absolute;inset:auto 0 12px 0;text-align:center;font-weight:700;opacity:.85}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .card{display:none;text-align:center;animation:fade .8s ease}
  .card.show{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  .img{width:220px;height:220px;border-radius:20px;margin:0 auto 16px;background:#1112;display:grid;place-items:center;
       box-shadow:0 16px 40px rgba(244,114,182,.25);overflow:hidden}
  .img img{width:100%;height:100%;object-fit:cover}
  .name{font-family:"Playfair Display",serif;font-size:28px;
        background:linear-gradient(135deg,var(--gold),var(--accent1));
        -webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
  .role{color:var(--accent2);margin-bottom:10px}
  .whisper{opacity:.95;font-style:italic;max-width:560px;margin:0 auto}
  .hint{opacity:.65;font-size:13px;text-align:center;margin-top:12px}
  .lock{opacity:.6;font-size:12px;margin-top:10px}
  .reset{color:#fff;text-decoration:underline;cursor:pointer}
  footer{opacity:.75;text-align:center;margin:48px 0 10px;font-size:14px}
  .note{opacity:.8;text-align:center;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Reveal Your Soul-Bonded Companion</h1>
    <p class="lead">Choose your species, breathe in… then tap the circle once. The first reveal mirrors your present energy best.</p>

    <div class="row">
      <select id="species" class="select" disabled>
        <option>Loading species…</option>
      </select>
      <button class="btn btn-primary" id="begin" disabled>Begin the Ritual</button>
    </div>

    <div class="stage" id="stage">
      <div class="circle" id="circle"><div class="tap">Tap to Reveal</div></div>
    </div>

    <div id="result" class="card">
      <div class="img" id="imgBox">✨</div>
      <div class="name" id="name">—</div>
      <div class="role" id="role">—</div>
      <div class="whisper" id="whisper">—</div>
      <p class="lock" id="lockHint">This reveal is saved on your device for this species. <span class="reset" id="reset">Reset</span></p>
      <p class="hint">Tip: Switching species lets you perform a new ritual for that species.</p>
      <p class="note" id="msg"></p>
    </div>

    <footer>Personal use only • © Vtomo</footer>
  </div>

<script>
/** 1) วางลิงก์ GViz JSON ของชีทที่นี่ */
const GVIZ_URL = "https://docs.google.com/spreadsheets/d/1C4roXeCrWmFI_xPGoGLdanQlJueINxaoUvfEs4uX_OA/gviz/tq?tqx=out:json&sheet=companions";
;

/** 2) State */
const KEY_PREFIX = "vtomo_reveal_v1_"; // บันทึกผลแยกต่อ species
let DB = {};          // { species: [ {name, role, whisper, image_url}, ... ] }
let speciesList = []; // ["wolf","cat",...]

/** 3) ดึงชีท (GViz JSON) และแปลงเป็น DB */
async function fetchSheet(){
  const res = await fetch(GVIZ_URL, {cache:'no-store'});
  const text = await res.text();
  // ตัด wrapper: google.visualization.Query.setResponse({...});
  const json = JSON.parse(text.replace(/^[^{]+/, '').replace(/;?\s*$/, ''));
  const cols = json.table.cols.map(c => c.label);
  const rows = json.table.rows.map(r => r.c.map(c => (c ? c.v : "")));

  const idx = {}; cols.forEach((k,i)=>idx[k]=i);
  DB = {};
  rows.forEach(r=>{
    const species = (r[idx['species']]||"").toString().trim().toLowerCase();
    if(!species) return;
    const item = {
      species,
      name: (r[idx['name']]||"").toString().trim(),
      role: (r[idx['role']]||"").toString().trim(),
      whisper: (r[idx['whisper']]||"").toString().trim(),
      image_url: (r[idx['image_url']]||"").toString().trim()
    };
    if(!DB[species]) DB[species]=[];
    DB[species].push(item);
  });
  speciesList = Object.keys(DB).sort();
}

/** 4) สร้าง dropdown จาก DB */
function populateSpecies(){
  const sel = document.getElementById('species');
  sel.innerHTML = "";
  speciesList.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s.charAt(0).toUpperCase()+s.slice(1);
    sel.appendChild(opt);
  });
  sel.disabled = false;
  document.getElementById('begin').disabled = false;

  // รองรับ ?species=wolf
  const sp = new URLSearchParams(location.search).get('species');
  if (sp && DB[sp]) sel.value = sp;
}

/** 5) เลือกครั้งเดียวต่อ species */
function pickOnceFor(species){
  const key = KEY_PREFIX + species;
  const saved = localStorage.getItem(key);
  if (saved) return JSON.parse(saved);

  const pool = DB[species] || [];
  if (!pool.length) throw new Error("No data for species: "+species);

  const idx = Math.floor(Math.random()*pool.length);
  const chosen = {...pool[idx], _idx: idx, _ts: Date.now()};
  localStorage.setItem(key, JSON.stringify(chosen));
  return chosen;
}

/** 6) แสดงผล */
function render(c){
  const imgBox = document.getElementById('imgBox');
  imgBox.innerHTML = c.image_url ? `<img src="${c.image_url}" alt="${c.name}">` : "✨";
  document.getElementById('name').textContent = c.name || "—";
  document.getElementById('role').textContent = c.role || "—";
  document.getElementById('whisper').textContent = c.whisper ? `“${c.whisper}”` : "—";
  document.getElementById('result').classList.add('show');
  document.getElementById('result').scrollIntoView({behavior:'smooth',block:'center'});
  document.getElementById('msg').textContent = "";
}

/** 7) เอฟเฟกต์ + reset */
function pulse(){
  const circle = document.getElementById('circle');
  circle.style.boxShadow = "0 0 120px rgba(244,114,182,.75)";
  setTimeout(()=>{ circle.style.boxShadow=""; }, 500);
}
function resetSpecies(species){
  localStorage.removeItem(KEY_PREFIX + species);
  location.reload();
}

/** 8) main */
(async function init(){
  try{
    await fetchSheet();
    if(!speciesList.length) {
      document.getElementById('msg').textContent = "No data found. Check your Google Sheet (headers & sharing).";
      return;
    }
    populateSpecies();

    // ถ้าเคยสุ่มไว้แล้วใน species ปัจจุบัน ให้โชว์ทันที
    const sp = document.getElementById('species').value;
    const saved = localStorage.getItem(KEY_PREFIX + sp);
    if (saved) render(JSON.parse(saved));
  }catch(e){
    document.getElementById('msg').textContent = "Loading error. Please try again later.";
    console.error(e);
  }

  document.getElementById('begin').addEventListener('click',()=>{
    document.getElementById('stage').scrollIntoView({behavior:'smooth'});
  });

  document.getElementById('circle').addEventListener('click', ()=>{
    const sp = document.getElementById('species').value;
    if(!sp){ alert("Please select a species first."); return; }
    pulse();
    const saved = localStorage.getItem(KEY_PREFIX + sp);
    if (saved){
      document.getElementById('msg').textContent = `You have already revealed your ${sp} companion on this device.`;
      render(JSON.parse(saved));
      return;
    }
    const c = pickOnceFor(sp);
    render(c);
  });

  document.getElementById('reset').addEventListener('click', ()=>{
    const sp = document.getElementById('species').value;
    if (confirm(`Reset the ${sp} reveal on this device?`)) resetSpecies(sp);
  });

  document.getElementById('species').addEventListener('change', ()=>{
    const sp = document.getElementById('species').value;
    const saved = localStorage.getItem(KEY_PREFIX + sp);
    if (saved) render(JSON.parse(saved));
    else {
      document.getElementById('result').classList.remove('show');
      document.getElementById('msg').textContent = `Ready to reveal your ${sp} companion.`;
    }
  });
})();
</script>
</body>
</html>


